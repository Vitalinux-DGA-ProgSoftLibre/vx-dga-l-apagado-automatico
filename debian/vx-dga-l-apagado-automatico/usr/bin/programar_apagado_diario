#!/bin/bash
## Programador de hora y minutos diarios para el apagado automático
## Arturo Martín Romero


USER=$(whoami)
if test $USER = "root"
then

	RES=$(yad --title="Desktop entry editor" --center --title "Programador Apagado" \
		--window-icon="shutdown" \
		--text="\n  Indica la Hora de Apagado:  \n" \
		--form --field="Hora:NUM" 0!0..24!1  --field="Minutos:NUM" 0!0..55!5 \
		--button="gtk-ok:0" --button="gtk-cancel:1")
	HORA=$(echo "$RES" | cut -d"|" -f1 | cut -d"," -f1)
	MINUTOS=$(echo "$RES" | cut -d"|" -f2 | cut -d"," -f1)
	MINUTODESPUES=$(expr $MINUTOS + 1)
	USER=$(who | grep " :0" | cut -d" " -f1)


    for USUARIO in alumno profesor dga ; do
	if test -f /var/spool/cron/crontabs/$USUARIO ; then
		chown $USUARIO /var/spool/cron/crontabs/$USUARIO
		chmod 600 /var/spool/cron/crontabs/$USUARIO
	fi
    done
	#echo "$MINUTODESPUES $HORA * * * root /sbin/init 0" > /etc/cron.d/apagado_automatico
	echo "$MINUTOS $HORA * * * root export DISPLAY=:0 && su $(who | grep ' :0 ' | cut -d' ' -f1) -c '/usr/bin/cuentaatras' --login" >> /etc/cron.d/apagado_automatico

else
	yad --title "Programar Apagado" --info --text " No tienes permiso para ejecutar el programa " \
		--window-icon="shutdown" \
		--width="400" --height="100" --center --justify="center" --text-align="center"
fi
